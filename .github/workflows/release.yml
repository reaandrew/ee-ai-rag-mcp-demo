name: Release and Deploy

on:
  workflow_run:
    workflows: ["Main Branch Quality Gate"]
    branches: [main]
    types:
      - completed

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write  # Needed for AWS auth

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "lts/*"

      - name: Install dependencies
        run: npm install

      - name: Semantic Release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use semantic-release directly and save the exit code
          npx semantic-release || echo "Semantic release process completed"
          
          # Check if a new tag was created by looking at git tags
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [[ ! -z "$LATEST_TAG" ]]; then
            echo "new_release_published=true" >> $GITHUB_OUTPUT
            # Remove v prefix if present
            VERSION=${LATEST_TAG#v}
            echo "new_release_version=$VERSION" >> $GITHUB_OUTPUT
            echo "A new release was published: $VERSION"
          else
            echo "new_release_published=false" >> $GITHUB_OUTPUT
            echo "No new release was published"
          fi

  terraform:
    name: Terraform Deploy
    needs: release
    runs-on: ubuntu-latest
    if: ${{ needs.release.outputs.new_release_published == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ee-ai-rag-mcp-demo-ci-role
          role-session-name: GitHub_AWS_Terraform
          aws-region: eu-west-2
          
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.7"
          
      - name: Build Lambda Packages
        run: |
          # Install pip dependencies
          python -m pip install --upgrade pip
          
          # Ensure build scripts are executable
          chmod +x ./install_lambda_deps.sh
          chmod +x ./build_lambda.sh
          
          # Build the Lambda layers - using simplified approach with minimal dependencies
          ./install_lambda_deps.sh
          
          # Build Lambda packages with utility modules
          ./build_lambda.sh
          
          # Verify the packages were created
          ls -la build/
          
          # Show the sizes of key packages
          du -h build/text-chunker-layer.zip
          du -h build/policy-search.zip
          du -h build/vector-generator.zip
          
      # Set environment variables for Terraform backend and variables
      - name: Set Terraform Environment Variables
        env:
          RELEASE_VERSION: ${{ needs.release.outputs.new_release_version }}
        run: |
          # Backend configuration
          echo "TF_STATE_BUCKET=ee-ai-rag-mcp-demo-terraform-state" >> $GITHUB_ENV
          echo "TF_LOCK_TABLE=ee-ai-rag-mcp-demo-terraform-locks" >> $GITHUB_ENV
          
          # Terraform variables
          echo "TF_VAR_environment=prod" >> $GITHUB_ENV
          echo "TF_VAR_app_version=${RELEASE_VERSION}" >> $GITHUB_ENV
          echo "TF_VAR_raw_pdfs_bucket_name=ee-ai-rag-mcp-demo-raw-pdfs" >> $GITHUB_ENV  # Remove version from bucket name
          echo "TF_VAR_extracted_text_bucket_name=ee-ai-rag-mcp-demo-extracted-text" >> $GITHUB_ENV  # Add proper prefix
          echo "TF_VAR_extracted_text_prefix=ee-ai-rag-mcp-demo" >> $GITHUB_ENV
          
          # For debugging
          echo "Setting up Terraform for version: ${RELEASE_VERSION}"
          

      - name: Terraform Init
        working-directory: ./terraform/app
        run: terraform init -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" -backend-config="region=eu-west-2" -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}" -backend-config="key=terraform/app/terraform.tfstate"
        
      - name: Terraform Plan
        working-directory: ./terraform/app
        run: terraform plan -out=tfplan
        
      - name: Terraform Apply
        working-directory: ./terraform/app
        run: terraform apply -auto-approve tfplan
        
      - name: Install Jinja2 for UI templating
        run: |
          python -m pip install jinja2>=3.1.2
          chmod +x ./scripts/render_template.py
      
      - name: Read Terraform outputs (JSON-safe)
        id: tf
        working-directory: ./terraform/app
        run: |
          set -euo pipefail

          # Pull every output once, as JSON
          TF_JSON=$(terraform output -json)

          # Extract the fields we need; jq prints *only* the value
          echo "ui_bucket=$(echo "$TF_JSON" | jq -r '.ui_bucket_name.value')"               >> $GITHUB_OUTPUT
          echo "search_api_url=$(echo "$TF_JSON" | jq -r '.policy_search_api_url.value')"   >> $GITHUB_OUTPUT
          echo "status_api_url=$(echo "$TF_JSON" | jq -r '.document_status_api_url.value')" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$(echo "$TF_JSON" | jq -r '.cloudfront_url.value')"          >> $GITHUB_OUTPUT
          
          # Display for logging
          echo "✓ UI Bucket:    $(echo "$TF_JSON" | jq -r '.ui_bucket_name.value')"
          echo "✓ Search API:   $(echo "$TF_JSON" | jq -r '.policy_search_api_url.value')"
          echo "✓ Status API:   $(echo "$TF_JSON" | jq -r '.document_status_api_url.value')"
          echo "✓ CloudFront:   $(echo "$TF_JSON" | jq -r '.cloudfront_url.value')"
      
      - name: Process and Deploy UI Files
        run: |
          echo "Deploying UI to bucket: ${{ steps.tf.outputs.ui_bucket }}"
          mkdir -p build/ui

          ${GITHUB_WORKSPACE}/scripts/render_template.py \
            --template ui/index.html \
            --output   build/ui/index.html \
            --search-api "${{ steps.tf.outputs.search_api_url }}" \
            --status-api "${{ steps.tf.outputs.status_api_url }}"

          aws s3 cp build/ui/index.html \
            s3://${{ steps.tf.outputs.ui_bucket }}/index.html \
            --content-type "text/html"

          aws s3 cp ui/documentation.html \
            s3://${{ steps.tf.outputs.ui_bucket }}/documentation.html \
            --content-type "text/html"

          aws s3 cp ui/images/ \
            s3://${{ steps.tf.outputs.ui_bucket }}/images/ --recursive

          echo "✅ UI deployed – see it at ${{ steps.tf.outputs.cloudfront_url }}"